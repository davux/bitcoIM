#! /usr/bin/python
# -*- coding: utf-8 -*-
# vi: sts=4 et sw=4

import sys
from bitcoim.db import SQL, Database
from bitcoin.controller import Controller
from conf import bitcoin as bitcoinConf, db
from logging import error

try:
    from conf import component as info
except ImportError:
    error("Error: Please create a file named 'conf.py' (e.g. rename and edit conf.py.example).\n")
    sys.exit(1)
try:
    from xmpp import client, protocol
except ImportError:
    error("Error: this program needs the Python XMPP library.")
    sys.exit(1)
from bitcoim.component import Component

reload(sys)
sys.setdefaultencoding('utf8')
SQL(url=db['file'])
database = Database(db['file'])
database.upgrade(1)
try:
    Controller(bitcoinConf['user'], bitcoinConf['password']).getinfo()
except IOError:
    error("Communication error with bitcoin client")
    sys.exit(1)
try:
    bitcoIM = Component(info['jid'], info['password'], info['server'], info['port'])
except Exception, message:
    error("Error while connecting to server: %s" % (message))
    sys.exit(1)
try:
    bitcoIM.loop(10)
except KeyboardInterrupt:
    bitcoIM.sayGoodbye()
